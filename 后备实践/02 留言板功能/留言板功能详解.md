# 留言板功能详解

## 前言

最近学习了留言板功能的实现，所以对其做一个小结

文章目录:

1 [实现思路](#1)

2 [MVC优化](#2)

3 [具体实现](#3)
 
 

## <span id="1">一 实现思路</span>

1 存储留言

S1 引入leanCloud数据库— av-min.js文件(cdn/npm安装等)

S2 初始化 数据库文件对象— AV.init方法（根据官方文档API）

S3 新建项目数据库 + 新建数据库表 + 新建一行数据内容（根据官方文档API）


2 提交留言

S1 创建 form表单 + 内容输入 +提交按钮

S2 监听提交事件: 获取表单 + 监听表单提交事件 + 获取输入留言内容 + 传入数据库表中（新建数据）


3 读取数据库数据 + 显示数据内容（留言内容）

S1 获取数据库中一个表的 所有数据内容对象（根据官方文档API）

S2 处理数据内容对象为数组

S3 ol元素 + 新建li节点，文本内容为数据库的数据文本

S4 标题居中 + 留言主体宽度&border-top + 留言内容padding&border-bottom


4 即时刷新提交的留言内容

S1 在提交留言内容后，立刻创建一个li节点，并且获取数据库的那条数据对象，作为节点内容

S2 清空已填值


## <span id="2">二 MVC优化</span>

1 创建立即执行函数 

2 创建MVC的V: 获取 所要操作的HTML容器元素

3 创建MVC的C: 对象/函数

S1 声明参数变量: 一般是 view + model + dom获取元素的操作

S2 创建init方法: 赋值参数变量 +　调用其他方法的入口(一般都有事件监听入口bindEvents)

S3 bindEvents方法: 内部调用  其他具体的事件回调函数


4 创建MVC的M: 涉及数据库数的增删查改

S1 创建model对象,里面有获取/存储数据等方法


```js
!function(){

  let model = {                         // 4.S1 创建model对象,里面有获取/存储数据等方法

    // 初始化数据库对象
    init: function(){
      var APP_ID = 'Uk1e5CaSFbxXzJnvV8T3eXP3-gzGzoHsz'
      var APP_KEY = '2aPToLfp5W2amgYWaB1i5d5x'
      AV.init({ appId: APP_ID, appKey: APP_KEY })
    },

    // 读取数据
    fetch: function(){
       var query = new AV.Query('Message')
       return query.find()               // 返回一个Promise对象
    },

    // 存入数据
    save: function(msgName,msgContent){
      let Message = AV.Object.extend('Message')
      let message = new Message()
      return message.save({		  // 返回一个Promise对象
        "name": msgName,
        "content": msgContent
      })
    }

  }


  let view = document.querySelector('section.message')   //2 创建MVC的V: 获取 所要操作的HTML容器元素

  let controller = {         		        // 3 创建MVC的C: 对象/函数
    view: null,	                                // 3.S1 声明参数变量
    model: null,
    msgList: null,
				
　　init: function(view,model){			// 3.S2 创建init方法: 赋值参数变量 +　调用其他方法的入口
      this.view = view
      this.model = model

      this.msgList = view.querySelector("#msgList")
      this.form = view.querySelector("#postmsg")

      this.model.init()
      this.loadMessages()
      this.bindEvents()
    },

    // 显示数据
    loadMessages: function(){
      this.model.fetch().then(
        (messages) => {		
           //console.log(messages)          // 返回的是对象数组

           let array = messages.map(message => message.attributes)
           array.forEach((item) => {	 
             let li = document.createElement('li')
             li.innerText = `${item.name}:${item.content}`
             this.msgList.appendChild(li)
           })          
          },
          function (error) {  // 异常处理
            console.log("留言出错了！请稍候再试")
          }
      )
    },

    // 3.S3 事件监听—存入数据
    bindEvents: function(){
      this.form.addEventListener("submit", (e) => {
        e.preventDefault()
        this.saveMessage()
      })
    },
    
    saveMessage: function(){  // 上传存储数据
        let myForm = this.form
        let msgName = myForm.querySelector("input[name=name]").value
        let msgContent = myForm.querySelector("input[name=content]").value

        this.model.save(msgName,msgContent).then(function(object){
             alert("存入留言成功")  

            // 即时刷新提交的留言内容
            let li = document.createElement('li')
            li.innerText = `${object.attributes.name}:${object.attributes.content}`
            let msgList = document.querySelector("#msgList")
            msgList.appendChild(li)
    
            // 清空已填值
            document.querySelector("input[name=name]").value = ''
            document.querySelector("input[name=content]").value = ''
          })
    }

  }  // controller对应

  controller.init(view,model)

}.call()

```

## <span id="3">三 具体实现</span>

1 HTML部分

```html

// 2.S1 创建 form表单 + 内容输入 +提交按钮
<section class="message">
  <h2>留言</h2> 
    
  <form action="" method="post" id="postmsg" style="width:700px; margin: 30px auto">
    <label> 姓名: <input type="text" name="name"></label>
    <label> 内容: <input type="text" name="content"></label>
    <input type="submit" value="提交">
  </form>

  <ol id="msgList"></ol>
</section>


```

2 JS部分

```js

// 1.S2 初始化 数据库文件对象— AV.init方法（根据官方文档API）

var APP_ID = 'Uk1e5CaSFbxXzJnvV8T3eXP3-gzGzoHsz';
var APP_KEY = '2aPToLfp5W2amgYWaB1i5d5x';

AV.init({
  appId: APP_ID,
  appKey: APP_KEY
});


// 1.S3 新建项目数据库 + 新建数据库表 + 新建一行数据内容（根据官方文档API）


// 测试代码
// var TestObject = AV.Object.extend('数据库表1');
// var testObject = new TestObject();

// testObject.save({
//   words: '这是一行数据内容'
// }).then(function(object) {
//   alert('存入数据成功了');
// })


// 2.S2 监听提交事件: 获取表单 + 监听表单提交事件 + 获取输入留言内容 + 传入数据库表中（新建数据）

let myForm = document.querySelector("#postmsg")

myForm.addEventListener("submit", function(e){
  e.preventDefault()

  // 上传存储数据
  let msgName = document.querySelector("input[name=name]").value
  let msgContent = document.querySelector("input[name=content]").value
  let Message = AV.Object.extend('Message')
  let message = new Message()
  message.save({
    "name": msgName,
    "content": msgContent
  }).then(function(object){
    alert("存入留言成功")  

    // 4 即时刷新提交的留言内容
    let li = document.createElement('li')
    li.innerText = `${object.attributes.name}:${object.attributes.content}`
    let msgList = document.querySelector("#msgList")
    msgList.appendChild(li)
    
    // 4.S2 清空已填值
    document.querySelector("input[name=name]").value = ''
    document.querySelector("input[name=content]").value = ''
  })

})


// 3.S1 获取数据库中一个表的 所有数据内容对象（根据官方文档API）

var query = new AV.Query('Message')

query.find()
  .then(
    function (messages) {		// 3.S2 处理数据对象格式
       //console.log(messages)          // 返回的是对象数组

       let array = messages.map(message => message.attributes)
       array.forEach((item) => {	 //3.S3 新建li节点，文本内容为数据库的数据文本
         let li = document.createElement('li')
         li.innerText = `${item.name}:${item.content}`
         let msgList = document.querySelector("#msgList")
         msgList.appendChild(li)
       })          
 
    },

    function (error) {  // 异常处理
      console.log("留言出错了！请稍候再试")
    }

  )


3 CSS部分

```css

// 3.S4 留言部分基本样式

section.message{
    margin: 50px auto;
    max-width: 720px;
    text-align: center;
}
section.message ol {border-top: 1px solid #ddd;}
section.message ol li {padding: 10px; border-bottom: 1px solid #ddd;}
```










