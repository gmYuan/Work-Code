# 后台管理页面

目录

1 [上传歌曲成功自动高亮新建列表区 + 填入相关歌曲信息到 歌曲详情区](#1)

2 [上传歌曲成功 存入数据库](#2)

3 [新建歌曲上传后 表单内容清空 + 歌曲列表区显示歌曲名称](#3)

4 [列表区显示 存储在数据库中的已有数据](#4)

5 [点击列表区后: 点击元素高亮 + 标题区取消高亮 + 详情区表单自动填入信息](#5)

6 [点击列表区后: 详情区标题变成编辑歌曲 & 再点标题区后高亮 + 点击标题区后: 详情区标题变成新建歌曲](#6)

7 [点击标题区后: 详情区已存歌曲的表单清空 + 未存歌曲/新上传的歌曲表单内容 不会被清空](#7)

8 [编辑详情区保存后: 列表区更新而非新建数据字段 + 修改的列表区元素保持高亮状态](#8)

9 [上传歌曲时 添加loading效果](#9)


## <span id="1"> 1 上传歌曲成功自动高亮新建列表区 + 填入相关歌曲信息到 歌曲详情区 </span>

1 Q: 如何实现 上传歌曲成功后，自动高亮新建列表区 + 填入相关歌曲信息到 歌曲详情区

A: S1 利用发布-订阅模式，上传歌曲成功后，返回歌曲相关信息数据 + 调用订阅提供的回调函数

S2 新建列表区 和 歌曲详情区 订阅上传事件，并提供回调函数

S3.1 新建列表区订阅的 回调函数:  激活列表区的高亮.actice

S3.2 歌曲列表区订阅的 回调函数:  去除当前所有高亮的列表项

S3.3 歌曲详情区订阅的 回调函数:  用获取的数据，替换渲染 占位的详情区表单的value值

S3.4 替换渲染的方法是，获取占位内容 + 创建占位符变量数组&遍历替换template里的占位符 + 重新渲染显示


## <span id="2"> 2 上传歌曲成功 存入数据库 + 用存入数据渲染页面 </span>

1 Q: 如何实现 新建歌曲区表单上传后 数据存入数据库

A: S1 根据官方文档，引入 leadCloud的数据库初始化代码 initAV.js

S2 利用事件委托，监听表单的提交事件, 监听函数内部的功能有:

S2.1 阻止默认事件

S2.2 获取表单的输入元素-输入值 (制作关键词数组 + 遍历数组 + 存入对应的key-value)
 
`易错点: 获取表单value值时，用find方法结合遍历时，可以把变量传入到 find选择器中`

S2.3 调用model.create()方法,从而把数据存入数据库中


2 Q: model.create()方法的功能及 实现步骤是什么

A: S0 功能是 把获取的表单key-value对象 存入数据库中 + 提供新数据以给页面渲染

S1 新建一个nowData对象，用以 记录新数据

S2 根据leadCloud文档 存储语法，创建Song表单 + 遍历传入的数据对象，写入字段

S3 查看数据库返回的字段对象，获取表单数据 赋值存入到 nowData对象中


3 Q: 如何实现 用存入数据渲染页面

A: S1 数据库要能传出最新的数据对象 nowData—— 返回一个Promise对象

S2 contoller中 用最新的model里的最新表单数据 + 调用view里的render方法

`易错点: 遍历的表单key，渲染页面的key 要和数据库返回的 保持一致`


## <span id="3"> 3 新建歌曲上传后 表单内容清空 + 歌曲列表区显示歌曲名称 </span>

1 Q: 如何实现 新建歌曲上传后 表单内容清空

A: 保存数据库数据成功后，用空数据再次渲染页面即可


2 Q: 如何实现 新建歌曲上传后 歌曲列表区 新建一个li+显示歌曲名称

A: S1 保存数据成功后，songform.js 通过发布订阅， 发布create事件

S2 songlist.js 订阅create事件: model里push数据 + view用数据渲染页面

S3.1 渲染页面要 获取model传入的表单数据对象 数组

S3.2 遍历数组，创建相同个数的li DOM元素

S3.3 遍历li元素，插入到ul中

S3.4 因为每次提交表单，都会触发一次 对li数组的遍历，所以需要在遍历li之前，需要先清除ul已有的li

S3.5 添加active的类名 + 去除兄弟元素的.active 的思路同上


## <span id="4"> 4 列表区显示 存储在数据库中的已有数据 </span>

1 Q: 如何实现 列表区显示 存储在数据库中的已有数据

A: S1 根据leancloud官方文档，获取 数据库里已存在的 表单字段数据

S2 把获取的数据 存入到本地model.data里，这样已创建/新创建的数据，就都在本地了

`以上功能实现于 model.fetch()方法`

S3 用本地数据model.data + view.render方法渲染页面
  
  - 因为fetch方法内部是一个异步操作，所以在controller中也要使用 then方法渲染页面

以上代码可参考 [数据库已存数据显示](https://github.com/gmYuan/163-music/commit/67ad4b949fe0fb77fda0a6e3b6b7619ece29ce7d)



## <span id="5"> 5 点击列表区后: 点击元素高亮 + 标题区取消高亮 + 详情区表单自动填入信息</span>

1 Q: 如何实现 点击列表区后: 点击元素高亮

A: S0 事件委托 + 高亮态切换

S1 利用事件委托，监听列表区元素的点击事件

S2 当点击后，给当前点击元素添加active类 + 去除兄弟元素的active类

`以上实现于songList.js的  controller.bindEvents + view.active`


2 Q: 如何实现 点击列表区后: 标题区取消高亮

A: S0 状态标记值 + 事件监听 + 发布订阅

S1 设置一个点击列表区元素的 状态标记值selected，默认为false

S2 监听列表区元素的点击事件，当列表区有点击事件后， 发布select事件 + 状态值this.selected变成true

S3 标题区订阅select事件，取消高亮active类

`以上实现于songList.js的  controller.bindEvents + window.eventHub`


具体代码，可参考 [点击列表区元素高亮 + 标题区取消高亮](https://github.com/gmYuan/163-music/commit/acc5048d0743a4c72aaf73f4a1772e4f86b18d5c)


3 Q: 如何实现 点击列表区后: 详情区表单自动填入信息

A: S0 状态标记值 + 事件监听 + 发布订阅

S1 监听列表区元素的点击事件，当列表区有点击事件后， 发布select事件 + 从model里获取该列表项的信息并 深拷贝传出

S2 songform订阅selected事件: 获取到从列表区传出的歌曲信息 + 用此信息渲染页面表单

具体代码，可参考 [点击列表区 详情区表单自动填入信息](https://github.com/gmYuan/163-music/commit/588caaf12520c94c7081961eb3ac9b1c09ed8ca6)


## <span id="6"> 6 点击列表区后: 详情区标题变成编辑歌曲 & 再点标题区后高亮 + 点击标题区后: 详情区标题变成新建歌曲</span>

1 Q: 如何实现 点击列表区后: 详情区标题变成编辑歌曲

A: S0 事件监听 + 发布订阅模式

S1 songList列表区 发布 select事件 + 传入数据

S2.1 songform详情区订阅 select事件: 调用view.showTitle方法—— 根据是否是 编辑状态，显示不同标题内容

S2.2 显示不同标题内容: 获取标题DOM元素 + 修改其文本内容


2 Q: 如何实现 点击列表区后: 再点标题区后高亮 + 去除列表区点击元素的高亮状态

A: S0 事件监听 + 发布订阅模式

S1 songTitle标签区发布委托 监听标题点击事件: 调用view.active() + 发布 new事件

S2 songList列表区订阅 new事件: 调用 view.clearActive()方法去除所有列表项 高亮


3 Q: 如何实现  点击标题区后: 详情区标题变成新建歌曲

A: S0 事件监听 + 发布订阅模式

S1 songTitle标签区发布委托 监听标题点击事件: 发布 new事件

S2 songForm详情区订阅 new事件: 调用view.render方法—— 用默认标题渲染页面


以上代码可参考 [点击列表区后: 详情区标题变成编辑歌曲 & 再点标题区后高亮 + 点击标题区后: 详情区标题变成新建歌曲](https://github.com/gmYuan/163-music/commit/a4c71b2781ac7952236e63447778b85b882a898a)


## <span id="7"> 7 点击标题区后: 详情区已存歌曲的表单清空 + 未存歌曲/新上传的歌曲表单内容 不会被清空</span>

1 Q: 如何实现 点击标题区后: 详情区已存歌曲的表单清空 + 未存歌曲/新上传的歌曲表单内容 不会被清空

A: S0  saved保存 数据标志位 + upload发布订阅事件 + select订阅事件 + new订阅事件

S1.1 songTitle标题区 设置this.saved = true的默认位

S1.2 songTitle标题区 `upload订阅事件时 状态为false + select订阅事件时状态为true`

S1.3 songTitle标题区 new发布事件传出 this.upload标志位 数据

S2 songForm详情区 new订阅事件 根据接收的状态位值，决定是否清空 已填入的表单内容数据


以上代码可参考[点击标题区后: 详情区已存歌曲的表单清空 + 未存歌曲/新上传的歌曲表单内容 不会被清空](https://github.com/gmYuan/163-music/commit/2d0b993f728b92776ce10c5246ac3ab8431b0a3a)



## <span id="8"> 8 编辑详情区保存后: 列表区更新而非新建数据字段 + 修改的列表区元素保持高亮状态 </span>

1 Q: 如何实现 编辑详情区保存后: 列表区更新 而非新建数据字段

A: S0  this.songsaved标记位 + 表单提交时根据标记位 进行新增/修改 字段 + 已存歌曲的id字段 + 官方文档

S1 设置歌曲保存标记位 this.songsaved，默认为false + 点击列表后变成true + upload/new订阅事件均为false

S2 在详情区的表单提交事件内，根据songsaved的标记位 进行判断  是新增数据库字段还是编辑字段

S3 因为 leancloud更新数据字段的文档要求有字段id, 所以创建this.id + 在列表区的select事件传入点击的id值


2 Q: 如何实现 编辑详情区保存后: 列表区的文本内容显示为 更新后的歌曲字段

A: S0 update发布订阅事件 + 遍历model的数据

S1 songForm 更新完成后，发布 update事件，把更新后的data数据对象传出

S2 songList 订阅update事件，遍历model中存的数据，id相同时曾更新model.data + 渲染页面


以上代码可参考 [新增列表编辑功能](https://github.com/gmYuan/163-music/commit/73c1982bafd4c930705cfcc62dc2433a30ee5a6a)



## <span id="9"> 9 上传歌曲时 添加loading效果 </span>

1 Q: 如何实现上传歌曲时 添加loading效果

A: S0 遮罩层 + 伪类 loading动画实现 + 上传歌曲生命周期 & 发布订阅模式 + 显示与隐藏函数

S1 在html页面中引入 div.mask，用于 动画时的遮罩层

S2 用::after伪类实现loading圆 + 绝对居中，默认隐藏

S3 用CSS动画 实现loading动画效果

S4.1 通过七牛上传歌曲的生命周期钩子，订阅上传前和上传后的事件

S4.2 创建loading.js文件，用于切换隐藏和显示的 函数